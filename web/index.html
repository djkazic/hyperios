<!DOCTYPE html>
<html>
  <head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>hyperiOS</title>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>
  <input id="pac-input" class="controls" type="text" placeholder="Enter a location">
  <div id="map"></div>
  <div id="sidebar">
  	<div class='panel panel-default'>
  		<div class='panel-heading'> <h3 id='title'>Hyperios</h3> </div>
  	</div>
  	<div id='loading' class='hidden'></div>
  	<div class='panel panel-danger hidden' id='casualtyContainer'>
  		<div class='panel-heading'> <h3 id='casualtyCounter'>10,000 casualties</h3> </div>
  	</div>
  	<div class='panel panel-danger hidden' id='hits'>
  		<div class='panel-heading'> <h3>Hit Sites</h3> </div>
  		<div class='panel-body'>
  			<ul id='hitList'>
  			</ul>
  		</div>
  	</div>
  </div>
	<script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
	<script>
		var map;
		var geocoder;
		var home = 'Boston, Massachusetts';
		var styles = [
		    {
		        "featureType": "all",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#191f1f"
		            }
		        ]
		    },
		    {
		        "featureType": "all",
		        "elementType": "labels.text.fill",
		        "stylers": [
		            {
		                "color": "#a4b0b0"
		            }
		        ]
		    },
		    {
		        "featureType": "all",
		        "elementType": "labels.text.stroke",
		        "stylers": [
		            {
		                "color": "#000000"
		            },
		            {
		                "weight": "1.5"
		            }
		        ]
		    },
		    {
		        "featureType": "administrative.country",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#0c0e0e"
		            }
		        ]
		    },
		    {
		        "featureType": "administrative.country",
		        "elementType": "geometry.stroke",
		        "stylers": [
		            {
		                "color": "#9a9a9a"
		            }
		        ]
		    },
		    {
		        "featureType": "landscape",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#191f1f"
		            }
		        ]
		    },
		    {
		        "featureType": "landscape.man_made",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#191f1f"
		            }
		        ]
		    },
		    {
		        "featureType": "landscape.natural",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#0c0e0e"
		            }
		        ]
		    },
		    {
		        "featureType": "landscape.natural.landcover",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#0c0e0e"
		            }
		        ]
		    },
		    {
		        "featureType": "landscape.natural.terrain",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#223030"
		            }
		        ]
		    },
		    {
		        "featureType": "road.highway",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "visibility": "on"
		            },
		            {
		                "color": "#38a6a6"
		            }
		        ]
		    },
		    {
		        "featureType": "road.highway",
		        "elementType": "geometry.stroke",
		        "stylers": [
		            {
		                "color": "#52c2c2"
		            }
		        ]
		    },
		    {
		        "featureType": "road.highway.controlled_access",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#38a6a6"
		            }
		        ]
		    },
		    {
		        "featureType": "road.highway.controlled_access",
		        "elementType": "geometry.stroke",
		        "stylers": [
		            {
		                "color": "#38a6a6"
		            }
		        ]
		    },
		    {
		        "featureType": "road.arterial",
		        "elementType": "geometry",
		        "stylers": [
		            {
		                "visibility": "on"
		            }
		        ]
		    },
		    {
		        "featureType": "road.arterial",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#080b0b"
		            },
		            {
		                "weight": "0.80"
		            }
		        ]
		    },
		    {
		        "featureType": "road.arterial",
		        "elementType": "geometry.stroke",
		        "stylers": [
		            {
		                "color": "#3f3f3f"
		            },
		            {
		                "weight": "0.50"
		            }
		        ]
		    },
		    {
		        "featureType": "road.local",
		        "elementType": "all",
		        "stylers": [
		            {
		                "visibility": "on"
		            }
		        ]
		    },
		    {
		        "featureType": "road.local",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#080b0b"
		            }
		        ]
		    },
		    {
		        "featureType": "road.local",
		        "elementType": "geometry.stroke",
		        "stylers": [
		            {
		                "color": "#2c3434"
		            },
		            {
		                "weight": "0.41"
		            }
		        ]
		    },
		    {
		        "featureType": "transit",
		        "elementType": "all",
		        "stylers": [
		            {
		                "visibility": "off"
		            }
		        ]
		    },
		    {
		        "featureType": "water",
		        "elementType": "geometry.fill",
		        "stylers": [
		            {
		                "color": "#c6d4ec"
		            }
		        ]
		    }
		];

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'));
			map.setOptions({styles: styles});

			geocoder = new google.maps.Geocoder();
			geolocate(geocoder, home, false);

			searchBar();
		}

		function searchBar() {
			var input = /** @type {!HTMLInputElement} */(
			document.getElementById('pac-input'));

			var types = document.getElementById('type-selector');
			map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

			var autocomplete = new google.maps.places.Autocomplete(input);
			autocomplete.bindTo('bounds', map);

			var infowindow = new google.maps.InfoWindow();

			autocomplete.addListener('place_changed', function() {
				infowindow.close();
				var place = autocomplete.getPlace();
				if (!place.geometry) {
					window.alert("Autocomplete's returned place contains no geometry");
					return;
				}

				// If the place has a geometry, then present it on a map.
				if (place.geometry.viewport) {
					map.fitBounds(place.geometry.viewport);
				} else {
					map.setCenter(place.geometry.location);
					map.setZoom(14);
				}

				//TRIGGER API CALL
				home = place.formatted_address;
				console.log(place);
				setTimeout(loop, 2000);
				$('#loading').removeClass('hidden');

				var address = '';
				if (place.address_components) {
					address = [
					  (place.address_components[0] && place.address_components[0].short_name || ''),
					  (place.address_components[1] && place.address_components[1].short_name || ''),
					  (place.address_components[2] && place.address_components[2].short_name || '')
					].join(' ');
				}
			});
		}

		function loop() {
			var addresses = [];
			var casualties = [];

			$.ajax({
				url: 'http://' + window.location.host + ':8888/api/search',
				method: 'POST',
				data: '{"city": "' + home + '"}'
			}).done(function(result) {
				var parsedRes = JSON.parse(result);
				var mixed = parsedRes.value;

				for (var i=0; i < 8; i++) {
					addresses[i] = mixed['poi_' + (i + 1)];
				}
				console.log("Addresses: " + addresses.length);
				correctLocList(addresses);

				for (var i=0; i < 8; i++) {
					casualties[i] = mixed['res_' + (i + 1)];
				}
				console.log("Casualties: " + casualties.length);

				var timeOffset = 3000;

				for (var i=0; i < addresses.length; i++) {
					console.log("Setting timeOut to " + timeOffset);
					console.log("Address data: " + addresses[i]);
					setTimeout(geolocate, timeOffset, geocoder, addresses[i], true);
					timeOffset += 2000;
				}

				// Increment timeOffset again and re-center at home
				timeOffset += 1000;
				setTimeout(geolocate, timeOffset, geocoder, home, false);
				setTimeout(setMapZoom, timeOffset + 1200, 12);
				setTimeout(setMapZoom, timeOffset + 1280, 11);
			});
		}

		function setMapZoom(zoom) {
			map.setZoom(zoom);
		}

		function geolocate(geocoder, address, marker) {
			geocoder.geocode({'address': address}, function(results, status) {
			  	if (status == google.maps.GeocoderStatus.OK) {
			  		var zoomLevel = 12;
			  		if (marker) {
			  			$('#casualtyContainer').removeClass('hidden');
						$('#hits').removeClass('hidden');
						$('#loading').addClass('hidden');

			  			console.log(results[0].geometry.location);
			  			var markerLatLng = new google.maps.Marker({
				  			map: map,
				  			position: results[0].geometry.location,
				  			animation: google.maps.Animation.DROP
				  		});

				  		var node = document.createElement("LI");
						var textnode = document.createTextNode(address);
						node.appendChild(textnode);

						document.getElementById("hitList").appendChild(node);
					  		//console.log(address + " => " + markerLatLng.position);
					  		zoomLevel += 4;
				  		}
			  		map.panTo(results[0].geometry.location);
			  		map.setZoom(zoomLevel);
			  	} else {
			  		console.log("Maps API error: " + status);
			  	}
			});
		}

		function correctLocList(loclist) {
			var lng_radius = 0.0003,         // degrees of longitude separation
			    lat_to_lng = 111.23 / 71.7,  // lat to long proportion in Warsaw
			    angle = 0.5,                 // starting angle, in radians
			    loclen = loclist.length,
			    step = 2 * Math.PI / loclen,
			    i,
			    loc,
			    lat_radius = lng_radius / lat_to_lng;
			for (i = 0; i < loclen; ++i) {
			    loc = loclist[i];
			    loc.lng = loc.lng + (Math.cos(angle) * lng_radius);
			    loc.lat = loc.lat + (Math.sin(angle) * lat_radius);
			    angle += step;
			}
		};
	</script>

	<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkj97OzWfnDLGen6ZxETMPEskLkpRAM2I&callback=initMap&libraries=places">
	</script>
  </body>
</html>