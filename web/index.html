<!DOCTYPE html>
<html>
  <head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Simple markers</title>
	<style>
	  html, body {
		height: 100%;
		margin: 0;
		padding: 0;
	  }
	  #map {
		height: 100%;
	  }
	</style>
  </head>
  <body>
	<div id="map"></div>
	<script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
	<script>
		var map;
		var geocoder;
		var home = 'Boston, Massachusetts';
		var styles = [
			{
			featureType: "all",
			stylers: [
			  { saturation: -80 }
			]
			},
			{
				featureType: "road.arterial",
				elementType: "geometry",
				stylers: [
				  { hue: "#00ffee" },
				  { saturation: 50 }
				]
			},
			{
				featureType: "poi.business",
				elementType: "labels",
				stylers: [
				  { visibility: "off" }
				]
			}
		];

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'));
			map.setOptions({styles: styles});

			geocoder = new google.maps.Geocoder();
			geolocate(geocoder, home, false);

			setTimeout(loop, 2000);
		}

		function loop() {
			var addresses = [];
			var casualties = [];

			$.ajax({
				url: 'http://' + window.location.host + ':8888/api/search',
				method: 'POST',
				data: '{"city": "' + home + '"}'
			}).done(function(result) {
				var parsedRes = JSON.parse(result);
				var mixed = parsedRes.value;

				for (var i=0; i < 8; i++) {
					addresses[i] = mixed['poi_' + (i + 1)];
				}
				console.log("Addresses: " + addresses.length);
				correctLocList(addresses);
				
				for (var i=0; i < 8; i++) {
					casualties[i] = mixed['res_' + (i + 1)];
				}
				console.log("Casualties: " + casualties.length);

				var timeOffset = 3000;

				for (var i=0; i < addresses.length; i++) {
					console.log("Setting timeOut to " + timeOffset);
					console.log("Address data: " + addresses[i]);
					setTimeout(geolocate, timeOffset, geocoder, addresses[i], true);
					timeOffset += 2000;
				}

				// Increment timeOffset again and re-center at home
				timeOffset += 1000;
				setTimeout(geolocate, timeOffset, geocoder, home, false);
				setTimeout(setMapZoom, timeOffset + 1200, 12);
				setTimeout(setMapZoom, timeOffset + 1280, 11);
			});	
		}

		function setMapZoom(zoom) {
			map.setZoom(zoom);
		}

		function geolocate(geocoder, address, marker) {
			geocoder.geocode({'address': address}, function(results, status) {
			  	if (status == google.maps.GeocoderStatus.OK) {
			  		var zoomLevel = 12;
			  		if (marker) {
			  			console.log(results[0].geometry.location);
			  			var markerLatLng = new google.maps.Marker({
				  			map: map,
				  			position: results[0].geometry.location,
				  			animation: google.maps.Animation.DROP
				  		});
				  		//console.log(address + " => " + markerLatLng.position);
				  		zoomLevel += 4;
			  		}
			  		map.panTo(results[0].geometry.location);
			  		map.setZoom(zoomLevel);
			  	} else {
			  		console.log("Maps API error: " + status);
			  	}
			});
		}

		function correctLocList(loclist) {
			var lng_radius = 0.0003,         // degrees of longitude separation
			    lat_to_lng = 111.23 / 71.7,  // lat to long proportion in Warsaw
			    angle = 0.5,                 // starting angle, in radians
			    loclen = loclist.length,
			    step = 2 * Math.PI / loclen,
			    i,
			    loc,
			    lat_radius = lng_radius / lat_to_lng;
			for (i = 0; i < loclen; ++i) {
			    loc = loclist[i];
			    loc.lng = loc.lng + (Math.cos(angle) * lng_radius);
			    loc.lat = loc.lat + (Math.sin(angle) * lat_radius);
			    angle += step;
			}
		};
	</script>

	<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkj97OzWfnDLGen6ZxETMPEskLkpRAM2I&callback=initMap">
	</script>
  </body>
</html>